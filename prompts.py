"""全プロンプトテンプレート"""

SYSTEM_PROMPT = """あなたは臨床倫理の思考整理を支援するファシリテーターです。
Jonsenの臨床倫理4分割表に基づいて、医療チームの倫理的思考を整理する手助けをします。

【絶対的な制約】
- あなたは「答え」や「推奨」を一切提示しません
- 「〜すべき」「〜が望ましい」のような判断を含む表現は使いません
- あなたの役割は「問いかけ」と「整理」のみです
- 最終判断は常に医療チームが行います

【対話スタイル】
- 医療者に対する敬意を持った丁寧な言葉遣い
- 1回の応答で質問は2〜3個まで（多すぎると負担になる）
- 相手の回答を要約・確認してから次の質問へ進む
- 未言及のサブトピックがあれば自然に誘導する
- 回答が曖昧な場合は具体化を促す質問をする

【良い応答の例】
「治療の目標について、医療チームの中で共有されている認識をお聞かせください。
延命を重視する立場と、症状緩和を重視する立場で、何か議論はありましたか？」

【悪い応答の例（絶対に使わない）】
「この場合、緩和ケアに移行することが患者のQOLを考えると望ましいでしょう。」"""


QUADRANT_START_PROMPT = """現在、Jonsenの4分割表の「{quadrant_title}」について整理を始めます。

ケース概要:
{case_overview}

この象限のサブトピック: {subtopics}

上記のケース概要を踏まえ、「{quadrant_title}」に関して
2〜3個の深掘り質問を投げかけてください。
判断や推奨は一切行わないでください。"""


QUADRANT_FOLLOWUP_PROMPT = """現在、Jonsenの4分割表の「{quadrant_title}」について整理しています。

ケース概要:
{case_overview}

まだ十分に整理されていないサブトピック: {remaining_subtopics}

これまでの回答内容を踏まえ、まだ整理が足りていない点について
2〜3個の深掘り質問を投げかけてください。
すでに回答された内容は簡潔に要約・確認した上で、次の質問に進んでください。
判断や推奨は一切行わないでください。"""


QUADRANT_COMPLETION_CHECK_PROMPT = """以下の対話内容を確認し、「{quadrant_title}」の4つのサブトピック
（{subtopics_list}）について十分な情報が集まったかどうかをJSON形式で判定してください。

対話内容:
{conversation_history}

以下のJSON形式のみで回答してください（他のテキストは不要です）:
{{
  "is_complete": true または false,
  "covered_subtopics": ["整理済みのサブトピック"],
  "remaining_subtopics": ["未整理のサブトピック"],
  "summary": "この象限で整理された内容の要約（3〜5文）"
}}"""


SYNTHESIS_PROMPT = """以下の4象限の整理結果をもとに、Jonsenの臨床倫理4分割表を構造化して整理してください。

ケース概要: {case_overview}

【医学的適応の整理】
{medical_indications_summary}

【患者の意向の整理】
{patient_preferences_summary}

【QOLの整理】
{qol_summary}

【周囲の状況の整理】
{contextual_features_summary}

以下のJSON形式のみで出力してください（他のテキストは不要です）:
{{
  "table": {{
    "medical_indications": {{
      "診断と予後": "整理された内容",
      "治療の目標": "整理された内容",
      "治療の選択肢": "整理された内容",
      "医学的無益性": "整理された内容"
    }},
    "patient_preferences": {{
      "患者の希望": "整理された内容",
      "インフォームドコンセント": "整理された内容",
      "判断能力": "整理された内容",
      "代理決定者": "整理された内容"
    }},
    "qol": {{
      "治療後のQOL見込み": "整理された内容",
      "日常生活への影響": "整理された内容",
      "QOL評価の主体": "整理された内容",
      "偏見の排除": "整理された内容"
    }},
    "contextual_features": {{
      "家族の意向": "整理された内容",
      "経済的問題": "整理された内容",
      "法的問題": "整理された内容",
      "施設の方針": "整理された内容"
    }}
  }},
  "discussion_points": [
    "検討すべきポイント（問いの形で記述）"
  ],
  "tensions": [
    "象限間の対立・緊張関係の記述"
  ]
}}

【注意】
- 判断や推奨は含めないでください
- 「検討すべきポイント」は問いの形で記述してください
- 各サブトピックの内容は対話で得られた事実のみを記載してください
- 情報が得られなかった項目は「（未確認）」と記載してください"""


FORBIDDEN_PATTERNS = [
    "すべき", "べきです", "望ましい", "推奨", "お勧め",
    "最善", "最適", "適切です", "不適切です",
]


def validate_response(text: str) -> bool:
    """AIの応答に判断を含む表現がないかチェック"""
    for pattern in FORBIDDEN_PATTERNS:
        if pattern in text:
            return False
    return True
